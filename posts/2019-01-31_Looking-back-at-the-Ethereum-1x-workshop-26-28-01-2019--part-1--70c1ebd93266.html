<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>
      Looking back at the Ethereum 1x workshop 26–28.01.2019 (part 1)
    </title>
    <style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html,
      body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field="subtitle"],
      section[data-field="description"] {
        display: none;
      }
    </style>
  </head>
  <body>
    <article class="h-entry">
      <header>
        <h1 class="p-name">
          Looking back at the Ethereum 1x workshop 26–28.01.2019 (part 1)
        </h1>
      </header>
      <section data-field="subtitle" class="p-summary">
        We held a small event at the Stanford University Campus, which was
        kindly hosted by Stanford, supported by Ethereum Foundation and…
      </section>
      <section data-field="body" class="e-content">
        <section
          name="2ebb"
          class="section section--body section--first section--last"
        >
          <div class="section-divider"><hr class="section-divider" /></div>
          <div class="section-content">
            <div class="section-inner sectionLayout--insetColumn">
              <h3
                name="c307"
                id="c307"
                class="graf graf--h3 graf--leading graf--title"
              >
                Looking back at the Ethereum 1x workshop 26–28.01.2019 (part 1)
              </h3>
              <p name="b4e3" id="b4e3" class="graf graf--p graf-after--h3">
                We held a small event at the Stanford University Campus, which
                was kindly hosted by Stanford, supported by Ethereum Foundation
                and ConsenSys, and benefited from participation of a number of
                Ethereum researchers, client developers, infrastructure
                engineers, dApp developers, and enthusiasts.
              </p>
              <p name="bf8d" id="bf8d" class="graf graf--p graf-after--p">
                Throughout these three days, we stayed focused on exploring the
                risks to the the longevity of Ethereum 1.0 from the
                technological point of view. Apart from the risks, we discussed
                various mitigations that would reduce these risks or delay their
                adverse effects.
              </p>
              <p name="82c8" id="82c8" class="graf graf--p graf-after--p">
                What makes these tasks both hugely rewarding and extremely
                challenging is the existence of the network, the blockchain, the
                cryptocurrency, and the ecosystem around the protocol and the
                software that we look into changing.
              </p>
              <p name="279e" id="279e" class="graf graf--p graf-after--p">
                I will start describing what we learnt during the workshop,
                piece by piece, so this will take multiple parts. Perhaps
                afterwards I will merge it into one paper.
              </p>
              <h3 name="f646" id="f646" class="graf graf--h3 graf-after--p">
                Problems with large (and growing) state
              </h3>
              <h4 name="3c16" id="3c16" class="graf graf--h4 graf-after--h3">
                <strong class="markup--strong markup--h4-strong"
                  >Failing snapshot sync</strong
                >
              </h4>
              <p name="82eb" id="82eb" class="graf graf--p graf-after--h4">
                Imagine the node on the bottom of the following picture is
                performing a snapshot sync from the node on the top of the
                picture. We are assuming “fast sync” mechanism here. Parts of
                the state trie getting synced are highlighted with green.
              </p>
              <figure
                name="2928"
                id="2928"
                class="graf graf--figure graf-after--p"
              >
                <div
                  class="aspectRatioPlaceholder is-locked"
                  style="max-width: 700px; max-height: 502px;"
                >
                  <div
                    class="aspectRatioPlaceholder-fill"
                    style="padding-bottom: 71.8%;"
                  ></div>
                  <img
                    class="graf-image"
                    data-image-id="1*DjIFLBvTjEbfiUQ17OtW1A.png"
                    data-width="1038"
                    data-height="745"
                    src="https://cdn-images-1.medium.com/max/800/1*DjIFLBvTjEbfiUQ17OtW1A.png"
                  />
                </div>
              </figure>
              <p name="ac98" id="ac98" class="graf graf--p graf-after--figure">
                Next, more of the state is synced, but the top node has moved on
                and pruned the state corresponding to the first block header:
              </p>
              <figure
                name="5331"
                id="5331"
                class="graf graf--figure graf-after--p"
              >
                <div
                  class="aspectRatioPlaceholder is-locked"
                  style="max-width: 700px; max-height: 557px;"
                >
                  <div
                    class="aspectRatioPlaceholder-fill"
                    style="padding-bottom: 79.5%;"
                  ></div>
                  <img
                    class="graf-image"
                    data-image-id="1*9e-JBWKYcx2_wkdswZ5SMA.png"
                    data-width="1049"
                    data-height="834"
                    src="https://cdn-images-1.medium.com/max/800/1*9e-JBWKYcx2_wkdswZ5SMA.png"
                  />
                </div>
              </figure>
              <p name="504f" id="504f" class="graf graf--p graf-after--figure">
                Next, block 1 is removed from the picture, the state at the
                block 2 is now pruned:
              </p>
              <figure
                name="2e51"
                id="2e51"
                class="graf graf--figure graf-after--p"
              >
                <div
                  class="aspectRatioPlaceholder is-locked"
                  style="max-width: 700px; max-height: 604px;"
                >
                  <div
                    class="aspectRatioPlaceholder-fill"
                    style="padding-bottom: 86.3%;"
                  ></div>
                  <img
                    class="graf-image"
                    data-image-id="1*dLJSAhKcFfETw3LC_nNwVw.png"
                    data-width="1063"
                    data-height="917"
                    src="https://cdn-images-1.medium.com/max/800/1*dLJSAhKcFfETw3LC_nNwVw.png"
                  />
                </div>
              </figure>
              <p name="8359" id="8359" class="graf graf--p graf-after--figure">
                And so on:
              </p>
              <figure
                name="9925"
                id="9925"
                class="graf graf--figure graf-after--p"
              >
                <div
                  class="aspectRatioPlaceholder is-locked"
                  style="max-width: 700px; max-height: 614px;"
                >
                  <div
                    class="aspectRatioPlaceholder-fill"
                    style="padding-bottom: 87.8%;"
                  ></div>
                  <img
                    class="graf-image"
                    data-image-id="1*ZSucGbfc78buWpxXwPFIgQ.png"
                    data-width="1045"
                    data-height="917"
                    src="https://cdn-images-1.medium.com/max/800/1*ZSucGbfc78buWpxXwPFIgQ.png"
                  />
                </div>
              </figure>
              <p name="58f7" id="58f7" class="graf graf--p graf-after--figure">
                State at the block 5 is getting closer to the point of pruning:
              </p>
              <figure
                name="7fda"
                id="7fda"
                class="graf graf--figure graf-after--p"
              >
                <div
                  class="aspectRatioPlaceholder is-locked"
                  style="max-width: 700px; max-height: 617px;"
                >
                  <div
                    class="aspectRatioPlaceholder-fill"
                    style="padding-bottom: 88.1%;"
                  ></div>
                  <img
                    class="graf-image"
                    data-image-id="1*IINOpOTZsTS3QKcT1lKbsA.png"
                    data-width="1075"
                    data-height="947"
                    data-is-featured="true"
                    src="https://cdn-images-1.medium.com/max/800/1*IINOpOTZsTS3QKcT1lKbsA.png"
                  />
                </div>
              </figure>
              <p name="b3c8" id="b3c8" class="graf graf--p graf-after--figure">
                Finally, the state at the block 5 is getting pruned, and the
                snapshot sync fails, with some of the leaves of the state trie
                missing, because they are not available on the source node
                anymore, after being pruned:
              </p>
              <figure
                name="9183"
                id="9183"
                class="graf graf--figure graf-after--p"
              >
                <div
                  class="aspectRatioPlaceholder is-locked"
                  style="max-width: 700px; max-height: 533px;"
                >
                  <div
                    class="aspectRatioPlaceholder-fill"
                    style="padding-bottom: 76.1%;"
                  ></div>
                  <img
                    class="graf-image"
                    data-image-id="1*XeFkpi7x1Tg_r4l7XR7Dgg.png"
                    data-width="1226"
                    data-height="933"
                    src="https://cdn-images-1.medium.com/max/800/1*XeFkpi7x1Tg_r4l7XR7Dgg.png"
                  />
                </div>
              </figure>
              <p name="e1eb" id="e1eb" class="graf graf--p graf-after--figure">
                I have first discovered this during my conversation with Trinity
                team (they are building Python client for Ethereum 1.0 and 2.0).
                Although Trinity client fully implements the Ethereum protocol,
                its nodes have troubles performing the snapshot sync.
              </p>
              <p name="8c0a" id="8c0a" class="graf graf--p graf-after--p">
                The illustration above is, of course, a simplification for the
                sake of initial understanding. The reality is more nuanced:
              </p>
              <ol class="postList">
                <li name="9cc4" id="9cc4" class="graf graf--li graf-after--p">
                  The merkle tree is not binary but 16-ary
                </li>
                <li name="4bf0" id="4bf0" class="graf graf--li graf-after--li">
                  Sync is happening from multiple peers at once
                </li>
                <li name="8a03" id="8a03" class="graf graf--li graf-after--li">
                  Illustration is based on the idea of Geth’s fast sync.
                  Parity’s warp sync works in a different way, i.e., it does not
                  download the merkle tree from root to leaves, but rather only
                  leaves organised in chunks
                </li>
                <li name="dc61" id="dc61" class="graf graf--li graf-after--li">
                  Geth’s current code does not prune the state history once it
                  is committed to the database, but rather it is pruning while
                  that history is still in memory. The default is to prune
                  histories older than 120 blocks in the past, but it can be
                  changed via “tree-cache-gens” command line option. However,
                  increasing this option also increase memory footprint of the
                  node. In addition, Geth commits state histories to the
                  database every now and then (by default whenever importing of
                  canonical blocks exceed 5 mins), and these histories are not
                  pruned later on.
                </li>
                <li name="1012" id="1012" class="graf graf--li graf-after--li">
                  Parity’s pruning is more consistent with the illustration
                  above. It does prune old state histories that were committed.
                </li>
              </ol>
              <p name="8335" id="8335" class="graf graf--p graf-after--li">
                <strong class="markup--strong markup--p-strong"
                  >Possible mitigations:</strong
                >
              </p>
              <ol class="postList">
                <li name="ad3d" id="ad3d" class="graf graf--li graf-after--p">
                  Ask node operators to keep state history for longer. This
                  consumes more disk space in case of Parity, and can also
                  increase the memory footprint in the case of Geth.
                </li>
                <li name="9040" id="9040" class="graf graf--li graf-after--li">
                  Change Geth’s code to commit the snapshot not every 5 min, but
                  on some predictable block numbers (for example, on block
                  numbers that are multiples of 20).
                </li>
                <li name="e972" id="e972" class="graf graf--li graf-after--li">
                  Develop and deploy snapshot sync mechanisms that does not
                  suffer from this failure and are able to “gracefully” rebase
                  their failed snapshot to the newer version (with the help of
                  the peers). I know such initiatives already exist in Geth,
                  Parity, Turbo-Geth and Trinity, and I expect them to be
                  accelerated from now on. On the day 3 of the event, I gave a
                  presentation about sync mechanisms (present and future), and
                  soon should be able to write about it.
                </li>
              </ol>
              <p name="1f59" id="1f59" class="graf graf--p graf-after--li">
                <strong class="markup--strong markup--p-strong"
                  >Further investigations:</strong
                >
              </p>
              <p name="b639" id="b639" class="graf graf--p graf-after--p">
                As you can hopefully see from above description, the snapshot
                sync failure is not a straightforward phenomenon. It depends not
                just on the bandwidth, pruning thresholds, but also on the
                composition of peers, their uptime, and so on. We will be using
                the toolset of whiteblock.io (part of the Emulation/Simulation
                working group) to study the properties of the sync failure by
                the means of repeatable experiments. Once it is clear that we
                understand the phenomenon well enough, we can use simulation
                framework to model the failures into the future.
              </p>
              <p name="6c2d" id="6c2d" class="graf graf--p graf-after--p">
                <strong class="markup--strong markup--p-strong"
                  >Solutions:</strong
                >
              </p>
              <p name="dc30" id="dc30" class="graf graf--p graf-after--p">
                Reduction of the state size, or at least the rate of its growth,
                should help limiting the problem, and allow the client software
                optimisations (such as advanced sync mechanisms) to catch up.
              </p>
              <h4 name="66c5" id="66c5" class="graf graf--h4 graf-after--p">
                Duration of snapshot sync
              </h4>
              <p name="9d08" id="9d08" class="graf graf--p graf-after--h4">
                Even if the previous problem is mitigated, it still takes longer
                and longer to perform a snapshot sync for a new node joining the
                Ethereum network.
              </p>
              <p name="06a7" id="06a7" class="graf graf--p graf-after--p">
                <strong class="markup--strong markup--p-strong"
                  >Possible mitigations:</strong
                >
              </p>
              <ol class="postList">
                <li name="e651" id="e651" class="graf graf--li graf-after--p">
                  Using advanced syncing mechanisms mentioned above, prioritise
                  syncing of the certain parts of the state. For example, one
                  can always prioritise syncing of the parts that are accessed
                  by the ongoing blocks.
                </li>
                <li name="005a" id="005a" class="graf graf--li graf-after--li">
                  Use techniques to compress the snapshots. For example, part of
                  the design of the Gastoken, which is one of the largest source
                  of newly created contracts, was to make the state created by
                  the Gastoken highly compressable. Other idea is to use some
                  data blob (like enumeration of all addresses) that can be
                  downloaded ahead of time, and enable further compression of
                  the state (like replacing addresses with their indices within
                  the enumeration).
                </li>
              </ol>
              <p name="c8a9" id="c8a9" class="graf graf--p graf-after--li">
                <strong class="markup--strong markup--p-strong"
                  >Further investigations:</strong
                >
              </p>
              <p name="0fd6" id="0fd6" class="graf graf--p graf-after--p">
                We would like to check the hypothesis that the sync time grows
                linearly with the state size, and if so, establish the
                coefficient of such linear function.
              </p>
              <p name="4e3b" id="4e3b" class="graf graf--p graf-after--p">
                <strong class="markup--strong markup--p-strong"
                  >Solutions:</strong
                >
              </p>
              <p name="6b0d" id="6b0d" class="graf graf--p graf-after--p">
                Reduction of the state size, or at least the rate of its growth,
                should help limiting the problem, and allow the client software
                optimisations (such as advanced sync mechanisms) to catch up.
              </p>
              <h4 name="37b5" id="37b5" class="graf graf--h4 graf-after--p">
                Slower block sealing
              </h4>
              <p name="d20b" id="d20b" class="graf graf--p graf-after--h4">
                To appear in the part 2 or later
              </p>
              <h4 name="2758" id="2758" class="graf graf--h4 graf-after--p">
                Slower processing of transactions reading from the state
              </h4>
              <p name="6995" id="6995" class="graf graf--p graf-after--h4">
                To appear in the part 2 or later
              </p>
              <h3 name="d1bf" id="d1bf" class="graf graf--h3 graf-after--p">
                Block gas limit increase and the State fees (formerly known as
                State rent) share initial steps
              </h3>
              <p name="b330" id="b330" class="graf graf--p graf-after--h3">
                To appear in the part 2 or later
              </p>
              <h3 name="4448" id="4448" class="graf graf--h3 graf-after--p">
                Stateless contract pattern is discouraged by the current
                gas schedule
              </h3>
              <p name="ee51" id="ee51" class="graf graf--p graf-after--h3">
                To appear in the part 2 or later
              </p>
              <h3 name="e094" id="e094" class="graf graf--h3 graf-after--p">
                eWASM interpreters could be a sensible first change even though
                gas cost might not be practical in the beginning
              </h3>
              <p name="508c" id="508c" class="graf graf--p graf-after--h3">
                To appear in the part 2 or later
              </p>
              <h3 name="4404" id="4404" class="graf graf--h3 graf-after--p">
                Chain pruning will become more relevant as we start constraining
                the state growth
              </h3>
              <p name="3cc6" id="3cc6" class="graf graf--p graf-after--h3">
                To appear in the part 2 or later
              </p>
              <h3 name="da8a" id="da8a" class="graf graf--h3 graf-after--p">
                Ethereum protocol changes do not need to take a year to
                be prepared
              </h3>
              <p
                name="f15d"
                id="f15d"
                class="graf graf--p graf-after--h3 graf--trailing"
              >
                To appear in the part 2 or later
              </p>
            </div>
          </div>
        </section>
      </section>
      <footer>
        <p>
          By
          <a href="https://medium.com/@akhounov" class="p-author h-card"
            >Alexey Akhunov</a
          >
          on
          <a href="https://medium.com/p/70c1ebd93266"
            ><time class="dt-published" datetime="2019-01-31T20:37:05.269Z"
              >January 31, 2019</time
            ></a
          >.
        </p>
        <p>
          <a
            href="https://medium.com/@akhounov/looking-back-at-the-ethereum-1x-workshop-26-28-01-2019-part-1-70c1ebd93266"
            class="p-canonical"
            >Canonical link</a
          >
        </p>
        <p>
          Exported from <a href="https://medium.com">Medium</a> on July 28,
          2020.
        </p>
      </footer>
    </article>
  </body>
</html>
